!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("jQuery"),require("Masonry")):"function"==typeof define&&define.amd?define(["jQuery","Masonry"],t):e.Redgoose=t(e.$,e.Masonry)}(this,function(e,t){"use strict";function o(){return"ontouchstart"in window||navigator.maxTouchPoints}function n(e){return new Promise(function(t){window.timer&&clearTimeout(window.timer),window.timer=setTimeout(t,e)})}function i(e,...t){for(let o=0;o<t.length;o++){let n=`\\{${o}\\}`,i=new RegExp(n,"g");e=e.replace(i,t[o])}return e}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;const r=640;function s(){const t=this;function n(){o()&&r<[window.innerWidth,window.innerHeight][0]&&t.$gnb.find(".gnb__dep-1 > li > div").prev().on("click",!1)}this.$header=e(".layout-header"),this.$gnb=this.$header.find(".gnb"),this.init=function(){n(),t.$header.find(".toggle-gnb").on("click",function(){e(this).toggleClass("toggle-gnb-active"),t.$gnb.toggleClass("gnb-active")})}}var l=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,o){return function n(i,r){try{var s=t[i](r),l=s.value}catch(e){return void o(e)}if(!s.done)return Promise.resolve(l).then(function(e){n("next",e)},function(e){n("throw",e)});e(l)}("next")})}};const a=30,c=300,d=80,u=20;function p(o){let n=(i=l(function*(t){let n=null;p(!1);try{n=yield e.ajax({url:`${o.options.root}/ajax/`,type:"post",data:{page:t,nest:r.srls.nest,category:r.srls.category,size:r.options.size,field:"srl,title,category_srl,json"},dataType:"json"})}catch(e){return alert("Server error"),console.error(e),p(!0),!1}return function(t,n=!1,i=!1){t.nextpage||r.$more.remove();if(!t.articles||!t.articles.length)return;let s=t.articles.map((e,t)=>{let n=`${o.options.root}/article/${r.options.nest||""}${e.srl}`,i=`${o.options.gooseRoot}/${e.json.thumbnail.url}`,s=`grid-item grid-item__hidden ${e.size_className}`;return`<div class="${s}">`+`<a href="${n}" data-srl="${e.srl}" title="${e.title}">`+`<figure style="background-image: url('${i}')">`+`${e.title}`+"</figure></a></div>"}).join(""),l=e(s);g(l.children("a")),r.$articles.append(l),r.masonry&&r.masonry.appended(l);n&&l.each(function(t){setTimeout(()=>{e(this).removeClass("grid-item__hidden")},d*t)});if(i){let o=l.eq(0),n=o.offset().top-a;o.attr("data-page",t.currentPage),e("html, body").stop().animate({scrollTop:n},c,"swing")}}(n,!0,!0),r.$more.children("a").attr("data-next",n.nextpage),r.masonry&&r.masonry.layout(),p(!0),!1}),function(e){return i.apply(this,arguments)});var i;const r=this;function s(e=!0){e?(r.$articles.addClass("masonry"),r.masonry=new t(r.selector_articles,{itemSelector:".grid-item",columnWidth:".grid-sizer",transitionDuration:"0s",hiddenStyle:{},visibleStyle:{}})):(r.$articles.removeClass("masonry"),r.masonry.destroy(),r.masonry=null)}function p(e){e?(r.$more.children("a").on("click",function(){return n(this.dataset.next).then(),!1}),r.$more.removeClass("loadMore-loading")):(r.$more.children("a").off("click"),r.$more.addClass("loadMore-loading"))}function h(){e(this).toggleClass("categories__toggle-active"),e(this).next().toggleClass("categories__index-active")}function f(t){if(!o.options.dynamicChangePageNumber)return;function n(){const t=r.$articles.children("[data-page]"),n=e(this).scrollTop();let i=null;if(!t.length)return!1;n+e(this).height()===e(document).height()?i=t.eq(t.length-1)?t.eq(t.length-1):null:(t.each(function(t){n>=e(this).offset().top-(a+5)&&(i=e(this))}),i||(i=t.eq(0))),function(e){if(!URL)return;let t=new URL(window.location.href),n=t.searchParams,i=t.searchParams.get("page");if(i=i?parseInt(i):1,e===i)return;1===e?n.delete("page"):n.set("page",e);let r=location.pathname+(n.toString()?`?${n.toString()}`:"");o.history.replace({url:r,type:"index"},null,r)}(i&&i.length?i.data("page"):1)}t?(e(window).off("scroll.redgoose"),e(window).on("scroll.redgoose",function(){clearTimeout(r.scrollTimer),r.scrollTimer=setTimeout(n,100)})):e(window).off("scroll.redgoose")}function g(t){function n(){r.destroyIndexEvent()}t.on("click",function(t){let i=e(this).data("srl");return i&&o.article.open(i,!0).then(n),!1})}this.srls={},this.options={},this.scrollTimer=null,this.selector_articles="#articles",this.$index=e(".index"),this.$articles=this.$index.find(".index__articles"),this.$category=this.$index.find(".index__categories"),this.$more=this.$index.find(".index__loadMore"),this.masonry=null,this.init=function(e={}){if(this.srls.nest=e.nest_srl,this.srls.category=e.category_srl,this.options.size=e.size||u,this.options.title=e.title||o.options.title,o.mode="index",this.$category.children(".categories__toggle").on("click",h),o.history.initPopEvent(),!this.$articles.length)return!1;g(this.$articles.find(".grid-item > a")),s(),r.$more.children("a").attr("href","javascript:;"),p(!0),f(!0)},this.pushPage=function(e){n(e).then()},this.destroyIndexEvent=function(){this.masonry&&s(!1),f(!1)},this.restoreIndexEvent=function(){this.masonry||s(!0),f(!0)},this.useMasonry=function(e){s(e)},this.useScrollEvent=function(e){f(e)}}const h={en:{msg_notFound:"Not found {0}",msg_errorIndexMode:"It is not currently in 'index' mode.",msg_errorArticleMode:"It is not currently in 'article' mode.",msg_notAvailablePopupMode:"Not available in pop-up mode."},ko:{msg_notFound:"{0} 값이 없습니다.",msg_errorIndexMode:"지금은 'index'모드가 아닙니다.",msg_errorArticleMode:"지금은 'article'모드가 아닙니다.",msg_notAvailablePopupMode:"팝업모드에서는 사용할 수 없습니다."}};var f=h[navigator.language]||h.en;function g(t){let o=(r=l(function*(o,n=!1){return o?"index"!==t.mode?(alert(f.msg_errorIndexMode),null):t.$popup&&t.$popup.length?(t.mode="article",c.backupIndexScrollTop=e(window).scrollTop(),t.$popup.addClass("popupArticle-show"),t.$app.addClass("disabled"),window.scrollTo(0,0),yield d(o,n,"push"),void h(!0)):(t.options.dev&&console.error(i(f.msg_notFound,"popup element")),null):(alert(i(f.msg_notFound,"'srl'")),null)}),function(e){return r.apply(this,arguments)});var r;let s=(a=l(function*(o=!1){"article"===t.mode?(t.mode="index",o&&window.history.back(),c.srl=null,t.$popup&&t.$popup.length&&(t.$app.removeClass("disabled").addClass("hidden"),t.$popup.removeClass("popupArticle-show").empty(),t.index.restoreIndexEvent(),yield n(10),t.index&&t.index.masonry.layout(),yield n(10),e("html,body").scrollTop(c.backupIndexScrollTop),c.backupIndexScrollTop=0,t.$app.removeClass("hidden"),h(!1)),t.index&&t.index.options&&(document.title=t.index.options.title)):alert(f.msg_errorArticleMode)}),function(){return a.apply(this,arguments)});var a;const c=this;e("html");function d(o,n=!1,i="push"){return new Promise(function(r){const l=`${t.options.root}/article/${o}/`;t.$popup&&(p(!0),c.srl=o,t.$popup.empty(),t.$popup.load(`${l}?mode=popup`,a=>{let d=e(a).find(".article__header > h1").text();d=d?`${t.options.title} / ${d}`:t.options.title,c.$body=e("#article"),c.$close=e("#closeArticle"),c.$prev=e("#goToPrevArticle"),c.$next=e("#goToNextArticle"),c.$like=e("#toggleLike"),function(e=!0){e?c.$close.on("click",()=>s(!0)):c.$close.off("click")}(),u(),function(e=!0){function t(){return c.go(this.dataset.srl,!0,"replace"),!1}e?(c.$prev.on("click",t),c.$next.on("click",t)):(c.$prev.off("click"),c.$next.off("click"))}(),n&&(t.options.dev&&console.warn("change url:",l,i),t.history[i||"push"]({url:l,srl:o,type:"article"},d,l)),p(!1),r()}))})}function u(){let o=(n=l(function*(o){return o?yield e.ajax({url:`${t.options.root}/ajax/uplike/`,type:"post",headers:{"redgoose-action":"uplike"},data:{srl:o},dataType:"json"}):null}),function(e){return n.apply(this,arguments)});var n;c.$like.hasClass("onLike-on")||(c.$like.off("click"),c.$like.on("click",function e(){const t=c.$like.children("em");let n=this.dataset.srl,i=parseInt(t.text());c.$like.addClass("onLike-on").off(),t.text(i+1),o(n).then(function(o){switch(o.state){case"success":break;case"error":t.text(i),c.$like.removeClass("onLike-on").on("click",e),console.error(o.message)}})}))}function p(t=!1){if(t){let t=e('<div class="loading" id="loading"><div class="spinner"></div></div>');e("body").append(t)}else e("#loading").remove()}function h(o){const n=e(window),i={left:37,right:39,esc:27,cmd:91,ctrl:17};let r=!0;o?(n.off("keyup.redgoose keydown.redgoose"),n.on("keyup.redgoose",function(e){switch(e.keyCode){case i.cmd:case i.ctrl:r=!0;break;case i.left:r&&c.prev();break;case i.right:r&&c.next();break;case i.esc:t.$popup&&c.close(!0)}}),n.on("keydown.redgoose",function(e){switch(e.keyCode){case i.left:case i.right:r=!0;break;default:r=!1}})):n.off("keyup.redgoose keydown.redgoose")}var g,m;this.backupIndexScrollTop=0,this.$close=null,this.$prev=null,this.$next=null,this.$like=null,this.$body=null,this.srl=null,this.open=(g=l(function*(e,t=!1){yield o(e,t)}),function(e){return g.apply(this,arguments)}),this.close=(m=l(function*(e){yield s(e)}),function(e){return m.apply(this,arguments)}),this.go=function(e,o,n="push"){e?"article"===t.mode&&t.index&&t.$popup?d(e,o,n).then():window.location.href=`${t.options.root}/article/${e}/`:alert(i(f.msg_notFound,"'srl'"))},this.prev=function(){try{if(!c.$prev||!c.$prev.length)throw i(f.msg_notFound,"article");let e=c.$prev.get(0).dataset.srl;if(!e)throw i(f.msg_notFound,"article srl");this.go(e,!0,"replace")}catch(e){return t.options.dev&&console.error(e),!1}},this.next=function(){try{if(!c.$next||!c.$next.length)throw i(f.msg_notFound,"article");let e=c.$next.get(0).dataset.srl;if(!e)throw i(f.msg_notFound,"article srl");this.go(e,!0,"replace")}catch(e){return t.options.dev&&console.error(e),!1}},this.init=function(o){return t.$popup&&t.$popup.length?(t.options.dev&&console.error(f.msg_notAvailablePopupMode),null):o&&o.srl?(delete t.index,delete t.popup,delete t.$popup,this.srl=parseInt(o.srl),t.mode="article",this.$body=e("#article"),this.$prev=e("#goToPrevArticle"),this.$next=e("#goToNextArticle"),this.$like=e("#toggleLike"),t.history.initPopEvent(),u(),void h(!0)):(console.error(i(f.msg_notFound,"article srl")),null)}}const m={root:"",gooseRoot:"",dynamicChangePageNumber:!0,dev:!1};return function(t){this.$app=e("main"),this.popup="popupArticle",this.$popup=e(`#${this.popup}`),this.mode=null,this.options=Object.assign({},m,t),this.history=new function(t){const o=e("head > title");function n(){return!!history.pushState}this.push=function(e,t,i){n()&&i&&(t&&o.text(t),history.pushState(e||null,t||i,i))},this.replace=function(e,t,i){n()&&i&&(t&&o.text(t),history.replaceState(e||null,t||i,i))},this.initPopEvent=function(){function e(e){const o=e.state;if(o&&o.type)switch(o.type){case"index":if("article"===t.mode){if(t.article.srl)return t.article.close(),!1;if(!t.index)return location.reload(),!1}return!1;case"article":if("index"===t.mode&&o.srl)return t.article.open(o.srl),!1;if("article"===t.mode&&t.article.srl!==o.srl)return t.article.go(o.srl),!1;break;default:return"article"===t.mode&&t.$popup?(t.article.close(),!1):(location.reload(),!1)}else{if("article"===t.mode&&t.$popup)return t.article.close(),!1;if("index"===t.mode&&t.$popup)return!1}return location.reload(),!1}n()&&(window.removeEventListener("popstate",e),window.addEventListener("popstate",e))}}(this),this.header=new s(this),this.index=new p(this),this.article=new g(this),o()&&e("html").addClass("touch")}});
